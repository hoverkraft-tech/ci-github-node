# NodeJS Continuous Integration
# ==========================
# Workflow to performs continuous integration steps agains a NodeJs project:
# - CodeQL analysis
# - Linting
# - Build
# - Test

name: NodeJS Continuous Integration

on:
  workflow_call:
    inputs:
      build:
        description: Build parameters. Must be a string or a json object.
        type: string
        required: false
        default: "build"
      checks:
        description: "Optional flag to enable check steps."
        type: boolean
        required: false
        default: true
      lint:
        description: "Optional flag to enable linting"
        type: boolean
        required: false
        default: true
      code-ql:
        description: "Code QL analysis language. See https://github.com/github/codeql-action"
        type: string
        required: false
        default: "typescript"
      test:
        description: "Optional flag to enable test."
        type: boolean
        required: false
        default: true
      coverage:
        description: "Specifify code coverage reporter. Supported values: 'codecov'"
        type: string
        required: false
        default: "codecov"
    secrets:
      codecov-token:
        description: "Codecov token. See [https://github.com/codecov/codecov-action](https://github.com/codecov/codecov-action)"
        required: false

jobs:
  code-ql:
    name: üõ°Ô∏è CodeQL Analysis
    if: inputs.checks == true && inputs.code-ql != ''
    permissions:
      security-events: write
    runs-on: "ubuntu-latest"
    steps:
      - uses: hoverkraft-tech/ci-github-common/actions/checkout@0.12.0
      - uses: github/codeql-action/init@v3.24.5
        with:
          languages: ${{ inputs.code-ql }}
      - uses: github/codeql-action/analyze@v3.24.5

  setup:
    name: ‚öôÔ∏è Setup
    runs-on: "ubuntu-latest"
    # FIXME: This is a workaround for having workflow ref. See https://github.com/orgs/community/discussions/38659
    permissions:
      contents: read
      id-token: write
    outputs:
      build-commands: ${{ steps.build-variables.outputs.commands }}
      build-artifact: ${{ steps.build-variables.outputs.artifact }}
    steps:
      # FIXME: This is a workaround for having workflow ref. See https://github.com/orgs/community/discussions/38659
      # jscpd:ignore-start
      - uses: hoverkraft-tech/ci-github-common/actions/checkout@0.12.0

      - id: oidc
        uses: ChristopherHX/oidc@v3
      - uses: actions/checkout@v4 # checks out called workflow
        with:
          path: ./self-workflow
          repository: ${{ steps.oidc.outputs.job_workflow_repo_name_and_owner }}
          ref: ${{ steps.oidc.outputs.job_workflow_repo_ref }}
      # jscpd:ignore-end

      - id: setup-node
        uses: ./self-workflow/actions/setup-node

      - id: build-variables
        uses: actions/github-script@v7
        with:
          script: |
            const buildInput = `${{ inputs.build }}`.trim();

            let commands = [];

            // Build input can be json or string
            try {
              const build = JSON.parse(buildInput);
              if (Array.isArray(build)) {
                commands = build;
              } else {
                commands = build.commands ?? ["build"];

                if (build.artifact) {
                  if(typeof build.artifact === 'string') {
                    build.artifact = build.artifact.trim().split('\n');
                  }
                  const sanitizedArtifacts = build.artifact
                    .map(artifact => artifact.trim())
                    .filter(Boolean)
                    .map(artifact => {
                      if(!artifact.includes('*')) {
                        return artifact;
                      }

                      // FIXME: Workaround to preserve full path to artifact
                      // Add a wildcard to the first folder of the path
                      const workspace = `${{ github.workspace }}`.replace(/\/([^/]+)/, '/*$1');
                      return `${workspace}/${artifact}`;
                    });

                  core.setOutput('artifact', sanitizedArtifacts.join('\n'));
                }
              }
            } catch (e) {
              commands = buildInput.split('\n');
            }

            const sanitizedCommands = commands.map(command => command.trim()).filter(Boolean);
            if(!sanitizedCommands.length) {
              core.setFailed('No build commands found');
            }

            core.setOutput('commands', sanitizedCommands.join('\n'));

  lint:
    name: üëï Lint
    if: inputs.checks == true && inputs.lint != false
    runs-on: "ubuntu-latest"
    needs: setup
    # jscpd:ignore-start
    # FIXME: This is a workaround for having workflow ref. See https://github.com/orgs/community/discussions/38659
    permissions:
      contents: read
      id-token: write
    steps:
      # FIXME: This is a workaround for having workflow ref. See https://github.com/orgs/community/discussions/38659
      - uses: hoverkraft-tech/ci-github-common/actions/checkout@0.12.0

      - id: oidc
        uses: ChristopherHX/oidc@v3
      - uses: actions/checkout@v4 # checks out called workflow
        with:
          path: ./self-workflow
          repository: ${{ steps.oidc.outputs.job_workflow_repo_name_and_owner }}
          ref: ${{ steps.oidc.outputs.job_workflow_repo_ref }}
      # jscpd:ignore-end

      - id: setup-node
        uses: ./self-workflow/actions/setup-node

      - id: has-installed-dependencies
        uses: ./self-workflow/actions/has-installed-dependencies
        with:
          dependencies: |
            nx
            prettier

      - name: ‚ôªÔ∏è NX cache
        if: fromJson(steps.has-installed-dependencies.outputs.installed-dependencies).nx == true
        uses: actions/cache@v4.0.0
        with:
          path: node_modules/.cache/nx
          key: ${{ runner.os }}-cache-nx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-cache-nx-

      - name: ‚ôªÔ∏è Prettier cache
        if: fromJson(steps.has-installed-dependencies.outputs.installed-dependencies).prettier == true
        uses: actions/cache@v4.0.0
        with:
          path: node_modules/.cache/prettier
          key: ${{ runner.os }}-cache-prettier-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-cache-prettier-

      - run: ${{ steps.setup-node.outputs.run-script-command }} lint

  build:
    name: üèóÔ∏è Build
    if: inputs.checks == true && inputs.build != ''
    runs-on: "ubuntu-latest"
    needs: setup
    # jscpd:ignore-start
    # FIXME: This is a workaround for having workflow ref. See https://github.com/orgs/community/discussions/38659
    permissions:
      contents: read
      id-token: write
    steps:
      # FIXME: This is a workaround for having workflow ref. See https://github.com/orgs/community/discussions/38659
      - uses: hoverkraft-tech/ci-github-common/actions/checkout@0.12.0

      - id: oidc
        uses: ChristopherHX/oidc@v3
      - uses: actions/checkout@v4 # checks out called workflow
        with:
          path: ./self-workflow
          repository: ${{ steps.oidc.outputs.job_workflow_repo_name_and_owner }}
          ref: ${{ steps.oidc.outputs.job_workflow_repo_ref }}
      # jscpd:ignore-end

      - id: setup-node
        uses: ./self-workflow/actions/setup-node

      - id: has-installed-dependencies
        uses: ./self-workflow/actions/has-installed-dependencies
        with:
          dependencies: |
            nx
            gatsby
            storybook

      - name: ‚ôªÔ∏è Gatsby cache
        if: fromJson(steps.has-installed-dependencies.outputs.installed-dependencies).gatsby == true
        uses: actions/cache@v4.0.0
        with:
          path: |
            .cache
            public
          key: ${{ runner.os }}-cache-gatsby-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-cache-gatsby-

      - name: ‚ôªÔ∏è Storybook cache
        if: fromJson(steps.has-installed-dependencies.outputs.installed-dependencies).storybook == true
        uses: actions/cache@v4.0.0
        with:
          path: node_modules/.cache/storybook
          key: ${{ runner.os }}-cache-storybook-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-cache-storybook-

      - run: |
          BUILD_COMMANDS="${{ needs.setup.outputs.build-commands }}"

          echo "$BUILD_COMMANDS" | while IFS= read -r COMMAND ; do
              # Trim whitespace
              COMMAND=$(echo "$COMMAND" | xargs)

              # Skip empty lines
              if [ -z "$COMMAND" ]; then
                  continue
              fi

              echo -e "\n - Running $COMMAND"
              yarn "$COMMAND"
          done

      - if: needs.setup.outputs.build-artifact
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: ${{ needs.setup.outputs.build-artifact }}

  test:
    name: üß™ Test
    if: inputs.checks == true && inputs.test == true
    runs-on: "ubuntu-latest"
    needs:
      - setup
      - build
    # FIXME: This is a workaround for having workflow ref. See https://github.com/orgs/community/discussions/38659
    permissions:
      contents: read
      id-token: write
    steps:
      # FIXME: This is a workaround for having workflow ref. See https://github.com/orgs/community/discussions/38659
      - uses: hoverkraft-tech/ci-github-common/actions/checkout@0.12.0

      - if: needs.setup.outputs.build-artifact
        uses: actions/download-artifact@v4
        with:
          name: build
          path: '/'

      - id: oidc
        uses: ChristopherHX/oidc@v3
      - uses: actions/checkout@v4 # checks out called workflow
        with:
          path: ./self-workflow
          repository: ${{ steps.oidc.outputs.job_workflow_repo_name_and_owner }}
          ref: ${{ steps.oidc.outputs.job_workflow_repo_ref }}

      - id: setup-node
        uses: ./self-workflow/actions/setup-node

      - id: has-installed-dependencies
        uses: ./self-workflow/actions/has-installed-dependencies
        with:
          dependencies: |
            jest

      - name: ‚ôªÔ∏è Get Jest cache dir
        id: jest-cache-dir-path
        if: fromJson(steps.has-installed-dependencies.outputs.installed-dependencies).jest == true
        run: |
          JEST_CACHE_DIR=$(${{ steps.setup-node.outputs.run-script-command }} jest --showConfig | grep -oP '(?<="cacheDirectory": ")[^"]+(?=")')
          echo "dir=$JEST_CACHE_DIR" >> "$GITHUB_OUTPUT"

      - name: ‚ôªÔ∏è Test cache
        if: steps.jest-cache-dir-path.outputs.dir
        uses: actions/cache@v4.0.0
        with:
          path: ${{ steps.jest-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-test-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-test-

      - run: ${{ steps.setup-node.outputs.run-script-command }} test:ci
        env:
          CI: "true"

      - name: üìä Code coverage
        if: inputs.coverage == 'codecov'
        uses: codecov/codecov-action@v4.0.1
        with:
          token: ${{ secrets.codecov-token }}
